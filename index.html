<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Validador de Tickets</title>

    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@0.19.1"></script>

    <style>
        body {
            margin: 0;
            background: radial-gradient(circle at top, #1b1c29, #0b0c0e 70%);
            color: #fff;
            font-family: "Space Grotesk", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            height: 100dvh;
            overflow: hidden;
        }

        h1 {
            margin-top: 10px;
            font-size: 1.7rem;
            font-weight: 600;
            text-align: center;
        }

        #scanner-box {
            width: 100%;
            max-width: 420px;
            background: rgba(255,255,255,0.08);
            padding: 16px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(14px);
            margin-top: 20px;
        }

        video {
            width: 100%;
            border-radius: 14px;
            background: #000;
        }

        #status {
            margin-top: 12px;
            padding: 12px;
            text-align: center;
            background: rgba(255,255,255,0.06);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        #user-info {
            margin-top: 16px;
            padding: 14px;
            background: rgba(0,0,0,0.35);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.12);
            display: none;
        }

        .success { color: #4dff9a; font-weight: 600; }
        .error { color: #ff4d4d; font-weight: 600; }

        #rescan, #flashBtn {
            width: 100%;
            margin-top: 18px;
            padding: 14px;
            background: linear-gradient(135deg,#5d3fff,#00c3ff);
            border: none;
            font-size: 1rem;
            color: white;
            border-radius: 14px;
            cursor: pointer;
            display: none;
        }

        #flashBtn {
            background: rgba(255,255,255,0.18);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>

    <h1>Validación de Tickets<br>Automatizaciones con IA</h1>

    <div id="scanner-box">
        <video id="video" autoplay playsinline></video>
        <div id="status">Apuntá al código QR para validar</div>
        <div id="user-info"></div>
        <button id="flashBtn">Activar Linterna</button>
        <button id="rescan">Escanear otro</button>
    </div>

    <script>
        const webhookURL = "https://garatt10.app.n8n.cloud/webhook-test/752561a4-b0f1-4dde-9b89-e751f818313b";

        const video = document.getElementById("video");
        const statusBox = document.getElementById("status");
        const rescanBtn = document.getElementById("rescan");
        const flashBtn = document.getElementById("flashBtn");
        const userBox = document.getElementById("user-info");

        const codeReader = new ZXing.BrowserQRCodeReader();
        let scanning = true;
        let currentStream = null;
        let torchOn = false;
        let track = null;

        async function startCamera() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cam = devices.find(d => d.kind === "videoinput");

                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: cam.deviceId,
                        facingMode: "environment",
                        advanced: [{ torch: false }]
                    }
                });

                track = currentStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (capabilities.torch) flashBtn.style.display = "block";

                video.srcObject = currentStream;
                decode();
            } catch (err) {
                statusBox.textContent = "❌ No se pudo acceder a la cámara.";
                statusBox.classList.add("error");
            }
        }

        async function toggleFlash() {
            if (!track) return;
            try {
                torchOn = !torchOn;
                await track.applyConstraints({ advanced: [{ torch: torchOn }] });
                flashBtn.textContent = torchOn ? "Apagar Linterna" : "Activar Linterna";
            } catch (err) {
                alert("Tu dispositivo no soporta la linterna en modo cámara.");
            }
        }

        async function decode() {
            if (!scanning) return;

            try {
                const result = await codeReader.decodeOnceFromVideoDevice(undefined, "video");
                scanning = false;
                navigator.vibrate?.(120);

                statusBox.textContent = "⏳ Validando...";
                sendToWebhook(result.text);

            } catch (e) {
                requestAnimationFrame(decode);
            }
        }

        async function sendToWebhook(token) {
            try {
                const res = await fetch(webhookURL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ Token: token })
                });

                const data = await res.json();

                if (res.ok) {
                    statusBox.textContent = "✔ Ticket validado";
                    statusBox.classList.add("success");

                    userBox.style.display = "block";
                    userBox.innerHTML = `
                        <strong>Nombre:</strong> ${data.nombre || "-"}<br>
                        <strong>Tipo Entrada:</strong> ${data.tipo || "-"}<br>
                        <strong>Estado:</strong> ${data.estado || "-"}
                    `;

                } else {
                    statusBox.textContent = "❌ Error en servidor";
                    statusBox.classList.add("error");
                }

                rescanBtn.style.display = "block";

            } catch (e) {
                statusBox.textContent = "❌ No hay conexión con el servidor";
                statusBox.classList.add("error");
                rescanBtn.style.display = "block";
            }
        }

        rescanBtn.onclick = () => {
            scanning = true;
            statusBox.textContent = "Apuntá al código QR para validar";
            statusBox.classList.remove("success", "error");
            userBox.style.display = "none";
            rescanBtn.style.display = "none";
            decode();
        };

        flashBtn.onclick = toggleFlash;

        startCamera();
    </script>

</body>
</html>
